<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <title>Boka Knivslipning</title>
    <meta
      name="description"
      content="Boka en tid för knivslipning hos Knivkalle. Välj datum, tid och antal knivar."
    />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link rel="stylesheet" href="assets/css/main.css" />

    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #111;
        color: #e4dcd0;
      }

      header {
        background-color: #111;
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #333;
      }

      header h1 {
        margin: 0;
        color: #fff;
        font-size: 2rem;
        font-weight: 600;
      }

      main {
        max-width: 600px;
        margin: 3rem auto;
        background-color: #1c1c1c;
        padding: 2rem;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        padding-top: 5rem;
      }

      h2 {
        color: #ffa500;
        text-align: center;
        font-weight: bold;
      }

      label,
      select,
      input,
      textarea {
        display: block;
        width: 100%;
        margin-top: 1rem;
        padding: 0.5rem;
        border-radius: 5px;
        border: none;
        font-size: 1rem;
      }

      input[type="submit"],
      button {
        margin-top: 1.5rem;
        padding: 0.75rem;
        background-color: #339dff;
        color: #e4dcd0;
        font-weight: bold;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-align: center;
        line-height: 1.2rem;
      }

      input[type="submit"][disabled] {
        opacity: 0.7;
        cursor: not-allowed;
      }

      .price {
        font-weight: bold;
        margin-top: 1rem;
        text-align: center;
        font-size: 1.2rem;
      }

      input,
      select,
      textarea {
        background-color: #ffffff;
        color: #141414;
        border: 1px solid #444;
      }

      .logo a {
        text-decoration: none;
        color: inherit;
      }

      .subtitle {
        text-align: center;
        margin-top: -0.5rem;
        margin-bottom: 2rem;
        color: #b9b2a8;
        font-size: 1rem;
      }
    </style>
  </head>

  <body class="is-preload">
    <div id="topbar">
      <div class="logo">
        <a href="index.html">Knivkalle</a>
      </div>

      <button id="menu-toggle">☰</button>

      <nav id="nav">
        <ul>
          <li>
            <a href="bokning.html" class="boka-btn-topbar">Boka slipning</a>
          </li>
          <li><a href="index.html#priser">Priser</a></li>
          <li><a href="index.html#kontakt">Kontakt</a></li>
          <li><a href="index.html#om-oss">Om oss</a></li>
        </ul>
      </nav>
    </div>

    <main>
      <h2>Boka Knivslipning</h2>
      <p class="subtitle">Välj när du vill att vi hämtar dina knivar.</p>

      <!--
        IMPORTANT:
        - Den här POST:ar direkt till n8n (Production URL).
        - n8n ska svara 302 Location -> tack.html
        - Ingen fetch/iframe behövs.
      -->
      <form
        id="bookingForm"
        action="https://hooks.knivkalle.se/webhook/bokning"
        method="POST"
      >
        <label>Tillgängliga datum:</label>
        <div
          id="dateList"
          style="display: grid; grid-template-columns: 1fr; gap: 0.5rem"
        ></div>

        <!-- Skickas med (val av datum) -->
        <input type="hidden" id="date" name="date" required />

        <label for="time">Välj tid:</label>
        <select id="time" name="time" required>
          <option value="" selected disabled>Välj ett datum först</option>
        </select>

        <label for="knives">Antal knivar:</label>
        <input
          type="number"
          id="knives"
          name="knives"
          value="2"
          min="2"
          required
        />

        <label for="name">Namn:</label>
        <input type="text" id="name" name="name" required />

        <label for="email">E-postadress:</label>
        <input type="email" id="email" name="email" required />

        <label for="phone">Telefonnummer:</label>
        <input type="tel" id="phone" name="phone" required />

        <label for="address">Adress:</label>
        <input type="text" id="address" name="address" required />

        <label for="notes">Övrigt (valfritt):</label>
        <textarea id="notes" name="notes" rows="3"></textarea>

        <!-- Honeypot (bots fyller ofta i allt) -->
        <input
          type="text"
          name="company"
          style="display: none"
          tabindex="-1"
          autocomplete="off"
        />

        <div class="price" id="priceDisplay">Pris: -</div>

        <input type="submit" id="submitBtn" value="Boka" />
      </form>
    </main>

    <script>
      const dateHiddenInput = document.getElementById("date");
      const timeInput = document.getElementById("time");
      const knivesInput = document.getElementById("knives");
      const priceDisplay = document.getElementById("priceDisplay");
      const form = document.getElementById("bookingForm");
      const dateListEl = document.getElementById("dateList");
      const submitBtn = document.getElementById("submitBtn");

      let availability = null;
      let selectedDate = null;

      function pad2(n) {
        return String(n).padStart(2, "0");
      }
      function toYMD(d) {
        return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(
          d.getDate()
        )}`;
      }

      function parseYMD(ymd) {
        const [y, m, d] = ymd.split("-").map(Number);
        return new Date(y, m - 1, d);
      }

      function formatDateSV(ymd) {
        const d = parseYMD(ymd);
        const weekday = d.toLocaleDateString("sv-SE", { weekday: "short" });
        const date = d.toLocaleDateString("sv-SE", {
          day: "2-digit",
          month: "2-digit",
        });
        return `${weekday} ${date}`;
      }

      function clearTimes(message = "Välj ett datum först") {
        timeInput.innerHTML = "";
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = message;
        opt.disabled = true;
        opt.selected = true;
        timeInput.appendChild(opt);
      }

      function setTimesForDate(ymd) {
        const allowedTimes = availability?.allowed?.[ymd] || [];
        timeInput.innerHTML = "";

        if (!allowedTimes.length) {
          clearTimes("Inga tider för det datumet");
          return;
        }

        const firstOpt = document.createElement("option");
        firstOpt.value = "";
        firstOpt.textContent = "Välj tid";
        firstOpt.disabled = true;
        firstOpt.selected = true;
        timeInput.appendChild(firstOpt);

        for (const t of allowedTimes) {
          const opt = document.createElement("option");
          opt.value = t;
          opt.textContent = t;
          timeInput.appendChild(opt);
        }
      }

      function calculatePrice(knives) {
        knives = parseInt(knives, 10);
        if (knives === 1) return 0;
        if (knives === 2) return 249;
        if (knives === 3) return 359;
        if (knives === 4) return 459;
        if (knives === 5) return 499;
        if (knives > 5) return 499 + (knives - 5) * 89;
        return 0;
      }

      function updatePrice() {
        const knives = parseInt(knivesInput.value, 10);
        if (!knives) {
          priceDisplay.textContent = "Pris: -";
          return;
        }
        priceDisplay.textContent = `Pris: ${calculatePrice(knives)} kr`;
      }

      function isAllowed(ymd, time) {
        const list = availability?.allowed?.[ymd];
        return Array.isArray(list) && list.includes(time);
      }

      function getMinDateYMD() {
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(tomorrow.getDate() + 1);
        return toYMD(tomorrow);
      }

      function renderDateList() {
        const minDateYMD = getMinDateYMD();
        const minTime = parseYMD(minDateYMD).getTime();

        const allowedDates = Object.keys(availability?.allowed || {})
          .filter((d) => {
            const t = parseYMD(d).getTime();
            return Number.isFinite(t) && t >= minTime;
          })
          .sort((a, b) => parseYMD(a).getTime() - parseYMD(b).getTime());

        dateListEl.innerHTML = "";

        if (!allowedDates.length) {
          const div = document.createElement("div");
          div.textContent = "Inga tider öppna just nu.";
          dateListEl.appendChild(div);
          clearTimes("Inga tider öppna");
          dateHiddenInput.value = "";
          selectedDate = null;
          return;
        }

        for (const d of allowedDates) {
          const times = availability.allowed[d] || [];

          const btn = document.createElement("button");
          btn.type = "button";
          btn.dataset.ymd = d;

          btn.style.display = "flex";
          btn.style.justifyContent = "space-between";
          btn.style.alignItems = "center";
          btn.style.width = "100%";
          btn.style.padding = "0.75rem";
          btn.style.borderRadius = "8px";
          btn.style.border = "1px solid #333";
          btn.style.background = "#121212";
          btn.style.color = "#e4dcd0";
          btn.style.cursor = "pointer";
          btn.style.marginTop = "0";
          btn.style.lineHeight = "1.2rem";
          btn.style.fontWeight = "600";

          const left = document.createElement("div");
          left.textContent = formatDateSV(d);

          const right = document.createElement("div");
          right.style.opacity = "0.9";
          right.style.fontWeight = "600";
          right.textContent = `${times.length} tider`;

          btn.appendChild(left);
          btn.appendChild(right);

          btn.addEventListener("click", () => selectDate(d));
          dateListEl.appendChild(btn);
        }

        // Ingen förvald dag
        selectedDate = null;
        dateHiddenInput.value = "";
        clearTimes("Välj ett datum först");
        highlightSelectedDate();
      }

      function highlightSelectedDate() {
        const buttons = Array.from(dateListEl.querySelectorAll("button"));
        for (const b of buttons) {
          const isSelected = selectedDate && b.dataset.ymd === selectedDate;
          b.style.outline = isSelected ? "2px solid #339dff" : "none";
        }
      }

      function selectDate(ymd) {
        selectedDate = ymd;
        dateHiddenInput.value = ymd;
        setTimesForDate(ymd);
        highlightSelectedDate();
        updatePrice();
      }

      async function loadAvailability() {
        const res = await fetch("availability.json", { cache: "no-store" });
        if (!res.ok) throw new Error("Kunde inte ladda availability.json");
        availability = await res.json();
      }

      (async () => {
        try {
          clearTimes("Laddar tider...");
          await loadAvailability();
          renderDateList();
          updatePrice();
        } catch (e) {
          console.error(e);
          clearTimes("Tekniskt fel: tider kunde inte laddas");
          alert("Kunde inte ladda tillgängliga tider. Försök igen senare.");
        }
      })();

      knivesInput.addEventListener("input", updatePrice);
      timeInput.addEventListener("change", updatePrice);

      // Validera, men låt browsern POST:a normalt (n8n redirectar med 302)
      form.addEventListener("submit", (event) => {
        const ymd = dateHiddenInput.value;
        const time = timeInput.value;
        const knives = parseInt(knivesInput.value, 10);

        if (!ymd) {
          event.preventDefault();
          alert("Välj ett datum.");
          return;
        }
        if (!time) {
          event.preventDefault();
          alert("Välj en tid.");
          return;
        }
        if (Number.isNaN(knives) || knives < 2) {
          event.preventDefault();
          alert("Minst 2 knivar.");
          return;
        }
        if (!isAllowed(ymd, time)) {
          event.preventDefault();
          alert("Välj en tillgänglig tid.");
          return;
        }

        // Stoppa dubbelklick
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.value = "Skickar...";
        }
      });
    </script>
  </body>
</html>
